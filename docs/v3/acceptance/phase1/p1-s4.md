# P1-S4 验收记录（检索）

- 阶段：P1-S4
- 日期：2026-03-13（计划）
- 负责人：TBD
- 版本/提交：TBD
- 状态：`Planned`

## 0. screenpipe 对照与对齐（020A）

- screenpipe 做法：`GET /search`（底层纯 FTS5，无 embedding 参与）+ `GET /search/keyword`（独立快速路径）。
- 本阶段对齐（020A）：线上检索仅 FTS5+过滤，不引入 hybrid；`/v1/search/keyword` 合并到 `/v1/search`（P1 无 embedding，拆分无意义）；对齐 API query params 与 response schema。

## 1. 范围与目标

- 范围：`/v1/search`（含原 keyword 路径，已合并）、返回字段契约与 UI 过滤交互。（020A：`/v1/search/keyword` 在 P1 不作为独立端点）
- 目标：确保检索准确、可过滤、可回溯，并验证 UI 与 API 参数映射一致。
- 对应 Gate 条件：
  - 精确词查询不低于对齐基线。
  - Search P95 <= 1.8s（标准时间窗）。
  - `/v1/search` 过滤参数契约完成率 = 100%。
  - Search SQL JOIN 策略一致性 = 100%（主路径 `frames INNER JOIN ocr_text`，不使用 LEFT JOIN）。
  - 可检索完整性一致性 = 100%（`frames.status='completed'` 与 `ocr_text` 记录数差异为 0）。
  - `/v1/search/keyword` 不作为独立端点暴露（请求不返回 2xx）。
  - 检索结果引用字段完整率 = 100%。
  - Search UI 过滤项契约映射完成率 = 100%。
  - 检索结果点击回溯成功率 >= 95%。

## 2. 环境与输入

- 运行环境：同 P1-S1。
- 配置与数据集：
  - 精确词查询集（>= 100 条）
  - 多过滤条件组合集（time/app/window/content_type）
- 依赖版本：search API 与索引版本

## 3. 验收步骤

1. 导入标准检索数据集，记录基线版本。
2. 运行精确词查询集，对比基线召回与排序。
3. 对 `/v1/search` 执行过滤组合测试（单参、多参、边界时间窗）。
4. 通过 SQL 日志或 `EXPLAIN QUERY PLAN` 抽样核对四类查询（`q` 空/非空 × 元数据过滤有/无）：主路径始终 `frames INNER JOIN ocr_text`；`frames_fts` 仅在 app/window/browser/focused 非空时追加；`ocr_text_fts` 仅在 `q` 非空时追加；主路径无 LEFT JOIN。
5. 执行完整性核对 SQL：`SELECT (SELECT COUNT(*) FROM frames WHERE status='completed') - (SELECT COUNT(*) FROM ocr_text);`，结果必须为 `0`。
6. 验证 `/v1/search` 的关键词路径性能（`/v1/search/keyword` 已合并，P1 不作为独立端点）。
7. 对 `GET /v1/search/keyword` 发起请求，验证不返回 2xx（避免独立端点回归）。
8. 抽样校验返回字段：`capture_id/frame_id/timestamp` 完整性。
9. 在 Search 页面逐项操作过滤器，抓包核对 UI 参数与 API 请求 1:1 对应。
10. 从检索结果点击回溯到 frame/timeline，统计成功率。

## 4. 结果与指标

### 4.1 数值指标（可放宽，但需达标）

- Search P95（目标 <= 1.8s）：
- 精确词查询相对基线（目标 >= 基线）：
- Search SQL JOIN 策略一致性（目标 = 100%）：
- 可检索完整性一致性（目标 = 100%）：
- 结果点击回溯成功率（目标 >= 95%）：

### 4.2 功能完成度指标（强制）

- 功能清单完成率（目标 100%）：
- API/Schema 契约完成率（目标 100%）：
- API 命名空间一致性（对外仅 `/v1/*`，目标 100%）：
- 关键功能用例通过率（目标 >= 95%）：

### 4.3 完善度指标（强制）

- 异常与降级场景通过率（目标 >= 95%）：
- 可观测性检查项完成率（目标 100%，日志/指标/错误码）：
- 文档与验收记录完整率（目标 100%）：

### 4.4 UI 验收（按阶段启用）

- 路由可达与基础状态可见性检查（健康态/错误态）：通过。
- UI 关键交互通过率（如 timeline/search/chat/citation）：本阶段检查 Search 过滤 + 结果回溯。
- UI 证据附件（截图/录屏/日志路径）：

## 5. 结论

- Gate 结论：`Pass` | `Fail`
- 依据：
- 阻塞项（若 Fail 必填）：

## 6. 风险与后续动作

- 风险：语义类查询退化可能影响后续 chat grounding。
- 后续动作：将语义退化样例转入 Chat 阶段专项回归。
