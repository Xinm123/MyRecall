# P1-S1 验收记录（基础链路）

- 阶段：P1-S1
- 日期：2026-03-05（计划）
- 负责人：TBD
- 版本/提交：TBD
- 状态：`Planned`

## 0. screenpipe 对照与对齐

- screenpipe 做法：UI 通过后端 API 驱动核心流程（search/chat/timeline），并要求健康状态可观测。
- 本阶段对齐：对齐“API 可驱动 + 状态可观测”；不要求与 screenpipe UI 技术栈一致。

## 1. 范围与目标

- 范围：Host 上传链路（`POST /v1/ingest` + 幂等重试）、Edge ingest/queue 骨架（`GET /v1/ingest/queue/status`）、Edge 页面基础可用。
- 协议基线（019A）：单次幂等上传，`capture_id` 去重，`200 already_exists` 幂等语义，queue/status 端点可观测。
- 目标：在本机双进程下跑通"采集文件 -> 上传 -> 入队 -> 可观测"最小闭环，并验证 UI 基线可用。
- 对应 Gate 条件：
  - 同机断网恢复后可自动重传，且重复上传不重复入库（`200 already_exists`，frames 表无重复行）。
  - ingest 队列可观测（`GET /v1/ingest/queue/status` 返回 pending/processing/completed/failed）完整。
  - UI 基线路由可达率 = 100%。
  - UI 健康态/错误态展示检查通过率 = 100%。

## 2. 环境与输入

- 运行环境：
  - Host：macOS（本机）
  - Edge：macOS（同机进程隔离）
- 配置与数据集：
  - `myrecall_client.env`、`myrecall_server.env`
  - 样本：正常 capture 50 条 + 重复 capture 10 条 + 断连窗口 1 次
- 依赖版本：Python/Flask/SQLite 版本记录到本节

## 3. 验收步骤

1. 启动 Edge 与 Host（debug 模式），确认两进程、两端口、两日志目录独立。
2. 访问 `/`、`/search`、`/timeline`，记录每个页面 HTTP 200 与首屏渲染截图。
3. 连续上传 50 条 capture（`POST /v1/ingest`，每条携带唯一 capture_id），记录每条的 HTTP 响应（201 Created）与 ingest 状态流转（pending → processing → completed）。
4. 人为制造断连（阻断 Host→Edge 连接 3 分钟），继续产生 capture（写入 Host buffer，不上传）。
5. 恢复连接，确认 Host 自动续传，断连期间 buffer 中的 capture 最终全部入队并收到 201。
6. 回放重复包（相同 capture_id 至少 10 条），核对去重结果：重复包返回 `200 OK + "status": "already_exists"`，`frames` 表无重复行。
7. 调用 `GET /v1/ingest/queue/status`，核对 pending/processing/completed/failed 计数与实际 DB 状态一致；检查错误码与失败重试日志。
8. 校验 UI 健康态与错误态：
   - 正常时显示"服务健康/队列正常"；
   - Edge 不可达时显示明确错误提示；
   - 恢复后状态自动回到健康。

## 4. 结果与指标

### 4.1 数值指标（可放宽，但需达标）

- 断连恢复重传成功率（目标 100%）：
- 重复包去重正确率（目标 100%）：
- 页面路由可达率（目标 100%）：

### 4.2 功能完成度指标（强制）

- 功能清单完成率（目标 100%）：
- API/Schema 契约完成率（目标 100%）：
- 关键功能用例通过率（目标 >= 95%）：

### 4.3 完善度指标（强制）

- 异常与降级场景通过率（目标 >= 95%）：
- 可观测性检查项完成率（目标 100%，日志/指标/错误码）：
- 文档与验收记录完整率（目标 100%）：

### 4.4 UI 验收（按阶段启用）

- 路由可达与基础状态可见性检查（健康态/错误态）：`/`、`/search`、`/timeline` 全通过。
- UI 关键交互通过率（如 timeline/search/chat/citation）：本阶段仅检查基础页面可打开与状态可见。
- UI 证据附件（截图/录屏/日志路径）：

## 5. 结论

- Gate 结论：`Pass` | `Fail`
- 依据：
- 阻塞项（若 Fail 必填）：

## 6. 风险与后续动作

- 风险：去重键设计错误可能在高并发下漏检。
- 后续动作：若失败，优先修复幂等键与重试状态机，再重跑本验收。
