# P1-S6 验收记录（Chat-2 路由与流式）

- 阶段：P1-S6
- 日期：2026-03-18（计划）
- 负责人：TBD
- 版本/提交：TBD
- 状态：`Planned`

## 0. screenpipe 对照与对齐

- screenpipe 做法：通过 Pi `--provider`/`--model` 启动参数 + `models.json` 配置进行 provider 切换；Pi stdout 以 JSON Lines 事件流式输出；无 auto-fallback chain。
- 本阶段对齐：对齐 Pi provider 路由机制和流式事件协议（DA-5：P1 不做自动 fallback）；通过 PiManager 重启 Pi 进程实现 provider 切换。

## 1. 范围与目标

- 范围：模型路由（provider/model 配置切换）、Pi 事件流式输出（SSE 透传）、Provider timeout 处理。
- 目标：在故障注入下仍可稳定返回，并让 UI 感知路由状态与 timeout 过程。P1 不实现 auto-fallback（DA-5，对齐 screenpipe）。
- 对应 Gate 条件：
  - Chat 首 token P95 <= 3.5s。
  - Provider 切换可重复通过。
  - Provider timeout 处理可重复通过（>15s first-token → abort → timeout error）。
  - 路由切换场景覆盖率 = 100%（provider 切换 + timeout 错误，不含 auto-fallback）。
  - 流式输出协议一致性用例通过率 = 100%。
  - 路由与 timeout 状态可见场景覆盖率 = 100%。

## 2. 环境与输入

- 运行环境：同 P1-S1。
- 配置与数据集：
  - 多 provider 配置（至少 2 种：如 OpenAI + Ollama 或 OpenAI + DashScope）
  - 故障注入：provider 超时（>15s）、Pi 进程 crash、provider 不可用
- 依赖版本：PiManager watchdog 版本、protocol.py 版本

## 3. 验收步骤

1. 分别配置不同 provider（如 OpenAI、Ollama），通过 UI 配置页面切换并验证 PiManager 重启 Pi 进程。
2. 在正常网络下运行问题集，统计首 token 延迟 P95。
3. 注入 provider 超时（>15s first-token），验证 PiManager abort 并返回 timeout error event。
4. 注入 Pi 进程 crash（SIGKILL），验证 watchdog 自动重启并返回 interrupt frame。
5. 验证流式输出协议：事件顺序（message_start → message_update* → message_end）、嵌套（turn_start 包含 agent_start/end）、终止标记（response 事件为最后一个）、error frame 格式。
6. 在 UI 中核验：当前 provider/model badge、timeout/error notification、Pi 健康状态指示器。
7. 重复故障注入场景至少 3 轮，确认结果可复现。

## 4. 结果与指标

### 4.1 数值指标（可放宽，但需达标）

- Chat 首 token P95（目标 <= 3.5s）：
- Provider 切换成功率（目标 = 100%）：
- Provider timeout 处理成功率（目标 = 100%）：
- 流式输出协议一致性通过率（目标 = 100%）：

### 4.2 功能完成度指标（强制）

- 功能清单完成率（目标 100%）：
- API/Schema 契约完成率（目标 100%）：
- 关键功能用例通过率（目标 >= 95%）：

### 4.3 完善度指标（强制）

- 异常与降级场景通过率（目标 >= 95%）：
- 可观测性检查项完成率（目标 100%，日志/指标/错误码）：
- 文档与验收记录完整率（目标 100%）：

### 4.4 UI 验收（按阶段启用）

- 路由可达与基础状态可见性检查（健康态/错误态）：通过。
- UI 关键交互通过率（如 timeline/search/chat/citation）：本阶段检查 provider/model badge + timeout/error notification + Pi 健康状态。
- UI 证据附件（截图/录屏/日志路径）：

## 5. 结论

- Gate 结论：`Pass` | `Fail`
- 依据：
- 阻塞项（若 Fail 必填）：

## 6. 风险与后续动作

- 风险：provider 不稳定导致用户体验抖动。
- 后续动作：将失败场景加入 P1-S7 E2E 固定回归。
