# P1-S6 验收记录（Chat-2 路由与流式）

- 阶段：P1-S6
- 日期：2026-03-18（计划）
- 负责人：TBD
- 版本/提交：TBD
- 状态：`Planned`

## 0. screenpipe 对照与对齐

- screenpipe 做法：通过统一 chat 接口与 provider 能力支持本地/云端模型切换。
- 本阶段对齐：对齐 provider 切换与流式交互；保持 Edge 侧路由与降级。

## 1. 范围与目标

- 范围：模型路由（local/cloud）、流式输出、超时降级与 fallback。
- 目标：在故障注入下仍可稳定返回，并让 UI 感知路由状态与降级过程。
- 对应 Gate 条件：
  - Chat 首 token P95 <= 3.5s。
  - 路由切换与超时降级可重复通过。
  - 路由切换场景覆盖率 = 100%。
  - 流式输出协议一致性用例通过率 = 100%。
  - 路由与降级状态可见场景覆盖率 = 100%。

## 2. 环境与输入

- 运行环境：同 P1-S1。
- 配置与数据集：
  - local/cloud provider 双配置
  - 故障注入：local 超时、cloud 超时、网络抖动
- 依赖版本：路由器、流式协议实现版本

## 3. 验收步骤

1. 分别配置 local-only、cloud-only、auto-fallback 三种模式。
2. 在正常网络下运行问题集，统计首 token 延迟 P95。
3. 注入 local 超时，验证自动切换到 cloud 并成功返回。
4. 注入 cloud 超时，验证 fallback 到 local 或可解释失败。
5. 验证流式输出协议：顺序、终止标记、错误帧格式一致。
6. 在 UI 中核验：当前路由、降级原因、恢复状态均可见。
7. 重复故障注入场景至少 3 轮，确认结果可复现。

## 4. 结果与指标

### 4.1 数值指标（可放宽，但需达标）

- Chat 首 token P95（目标 <= 3.5s）：
- 路由切换成功率（目标 = 100%）：
- 流式输出协议一致性通过率（目标 = 100%）：

### 4.2 功能完成度指标（强制）

- 功能清单完成率（目标 100%）：
- API/Schema 契约完成率（目标 100%）：
- 关键功能用例通过率（目标 >= 95%）：

### 4.3 完善度指标（强制）

- 异常与降级场景通过率（目标 >= 95%）：
- 可观测性检查项完成率（目标 100%，日志/指标/错误码）：
- 文档与验收记录完整率（目标 100%）：

### 4.4 UI 验收（按阶段启用）

- 路由可达与基础状态可见性检查（健康态/错误态）：通过。
- UI 关键交互通过率（如 timeline/search/chat/citation）：本阶段检查“路由状态 + 降级提示 + 流式中断提示”。
- UI 证据附件（截图/录屏/日志路径）：

## 5. 结论

- Gate 结论：`Pass` | `Fail`
- 依据：
- 阻塞项（若 Fail 必填）：

## 6. 风险与后续动作

- 风险：provider 不稳定导致用户体验抖动。
- 后续动作：将失败场景加入 P1-S7 E2E 固定回归。
