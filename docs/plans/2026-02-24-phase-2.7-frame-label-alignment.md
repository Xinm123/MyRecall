# Phase 2.7 Frame Label Alignment Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Eliminate chunk-level label drift by introducing frame-level metadata truth and explicit fallback semantics before Phase 3 starts.

**Architecture:** Keep MyRecall current capture and ingestion topology, but add frame-level metadata source tracking (`frame_observed|chunk_fallback|inferred`), confidence scoring, normalized label indexing, and search-side quality filtering. Align with screenpipe principles (capture-time context first, dedup at write-time, lightweight query-time computation) without requiring full event-driven capture rewrite.

**Tech Stack:** Python/Flask, SQLStore(SQLite), existing v3 API contracts, FTS pipeline, WebUI search/timeline.

---

## 1. Background and Problem Statement

MyRecall currently resolves most frame labels from chunk-level metadata fallback. This causes predictable duplication and semantic drift when app/window/focus state changes within one chunk.

Observed symptoms:
- Multiple frames in the same chunk share identical `app_name/window_name/focused/browser_url`.
- Intra-chunk context changes are underrepresented or mislabeled.
- Search and timeline can return noisy evidence with low label granularity.

Why this blocks Phase 3:
- Phase 3 requires screenpipe-aligned, evidence-first vision retrieval quality.
- Without frame-level truth or explicit fallback labeling, precision and trust degrade.

---

## 2. Scope and Non-Goals

## In Scope (Phase 2.7)
- Add frame metadata contract fields:
  - `metadata_source`: `frame_observed|chunk_fallback|inferred`
  - `metadata_confidence`: float in `[0.0, 1.0]`
  - `label_quality_score`: derived quality score for ranking/filtering.
- Add normalized label indexing path:
  - canonical label keying
  - uniqueness constraints
  - conflict policy (`ON CONFLICT DO NOTHING` semantic equivalent).
- Add asynchronous incremental index refresh SLA and observability.
- Add strict-mode filtering for search/timeline (`exclude chunk_fallback`).
- Keep API contract compatibility for existing clients while applying quality gates to new ingested data only.

## Out of Scope (Phase 2.7)
- Full event-driven capture replacement (strong screenpipe parity).
- External search engine migration.
- Audio pipeline expansion.
- Historical data backfill/relabeling.

## 2.1 Data Boundary (`T0`)

- `T0 = Phase 2.7 kickoff timestamp`.
- All Phase 2.7 metrics, sampling, and gate decisions are computed only from records with `timestamp >= T0`.
- Historical rows (`timestamp < T0`) are not reprocessed in this phase and do not affect Phase 2.7 Go/No-Go.

---

## 3. Critical Decision Record

### Decision A: Root-cause fix for label consistency

#### A1. Query-side dedup only (not selected)
- Core principle: Do not modify write path; merge duplicates only in result rendering.
- Compatibility: Fully compatible with current stack.
- Implementation complexity: Low.
- Maintenance cost: Medium due to persistent semantic debt.
- Estimated upside:
  - Precision gain: +5% to +12%
  - Delivery: 3-5 days.
- Estimated downside:
  - Still high mismatch under intra-chunk context changes.
  - Technical debt propagates into Phase 3/4.
- KPI impact:
  - Search latency p95: -5% to -10% (possible)
  - Accuracy and user trust: limited gains.
- Screenpipe alignment:
  - Low. Cannot fully align with capture-time truth philosophy.

#### A2. Frame-level truth + explicit fallback markers (selected)
- Core principle: Persist per-frame source and confidence, keep fallback but make it explicit.
- Compatibility: Native with SQLStore, Flask API, current schema evolution style.
- Implementation complexity: Medium.
- Maintenance cost: Medium and predictable.
- Estimated upside:
  - Accuracy gain: +20% to +35%
  - Search noise reduction: -25% to -40%
  - Search p95: +10% to +20% improvement from smaller high-quality candidate sets.
- Estimated downside:
  - Storage increase: +4% to +10%
  - Requires schema migration and index policy hardening.
- KPI impact:
  - Better relevance, controllable cost growth, clearer evidence quality.
- Screenpipe alignment:
  - Medium-high. Matches design philosophy without full pipeline rewrite.

#### A3. Full event-driven capture parity (not selected in this phase)
- Core principle: Capture context on app/window events; atomically write frame+context.
- Compatibility: Requires major capture loop and ingestion redesign.
- Implementation complexity: High.
- Maintenance cost: Medium-high.
- Estimated upside:
  - Accuracy gain: +35% to +55% long-term.
- Estimated downside:
  - 6-10 week effort, high regression risk, delayed Phase 3.
- Screenpipe alignment:
  - High, near-full parity.

**Final choice:** A2.

### Decision B: Index/search denoising strategy

#### B1. Keep current FTS + business-layer filters (not selected)
- Benefit too limited for Phase 3 gate quality.

#### B2. Normalized labels + uniqueness + deferred incremental indexing (selected)
- Core principle: Normalize labels before indexing, prevent duplicate insert churn, refresh index asynchronously.
- Estimated upside:
  - Duplicate index entries: -30% to -50%
  - Write lock contention: -15% to -30%.
- Screenpipe alignment:
  - High (similar tag uniqueness + deferred FTS ideas).

#### B3. Replace with external search engine (not selected)
- Not MVP-aligned; high operational burden.

**Final choice:** B2.

### Decision C: Milestone governance

#### C1. Independent Phase 2.7 hard gate before Phase 3 (selected)
- Estimated upside:
  - Phase 3 rework reduction: -20% to -40%.
- Rationale:
  - Prevents noisy metadata debt from entering Search/Chat foundation.

#### C2. Parallelize with Phase 3 (not selected)
- Higher short-term speed, higher rollback/rework risk.

#### C3. No standalone phase (not selected)
- Lacks measurable closure criteria.

---

## 4. Public Interfaces and Data Boundary

## Additive contract changes (document-first)
- Frame metadata fields:
  - `metadata_source` (`frame_observed|chunk_fallback|inferred`)
  - `metadata_confidence` (`0.0..1.0`)
- Search/Timeline fields:
  - `label_quality_score`
  - filter option `metadata_source != chunk_fallback` (strict mode)
- Index contract:
  - normalized label key definitions
  - conflict semantics
  - deferred indexing freshness SLA.

## API contract compatibility
- Existing clients continue to work with optional new fields.
- No breaking path in existing `/api/v1/search` and `/api/v1/timeline` response structure.

## Evaluation boundary
- Phase 2.7 quality/performance/resource acceptance uses only `timestamp >= T0` records.
- No historical backfill requirements are part of Phase 2.7 acceptance.

---

## 5. Phase 2.7 Deliverables

1. Schema and contract specification for frame metadata source/confidence.
2. Label normalization and dedup policy spec.
3. Search/timeline strict filtering and quality scoring spec.
4. KPI baseline protocol and acceptance report template.
5. Risk register and rollback criteria for all additive changes.

---

## 6. Acceptance Criteria (Hard Gate)

Phase 2.7 is **GO** only when all gates below pass:

1. All metrics and gates are evaluated only on records with `timestamp >= T0`.
2. Label mismatch rate reduced to `<=2%-5%` on sampled labeled dataset.
3. Search `Precision@10` improves by `>=20%` versus Phase 1.5 baseline.
4. Query p95 does not regress; target `10%-20%` improvement.
5. Resource increase bounded: CPU `<=+12%`, storage `<=+10%`.
6. No API compatibility regression and no new-write schema integrity failures.

---

## 7. Test Cases and Validation Scenarios

1. Intra-chunk app/window switch at frame N:
- Expected: post-switch frames show updated labels and higher source confidence.

2. Same app, multi-window changes:
- Expected: search by window title improves `Precision@10` significantly.

3. Strict mode filter:
- Expected: `chunk_fallback` frames can be excluded from main relevance results.

4. High-volume ingestion:
- Expected: deferred indexing keeps throughput stable and search freshness within SLA.

5. Sensitive URL/window titles:
- Expected: masking/redaction rules remain intact; no governance regression.

---

## 8. Risks, Counterexamples, and Mitigations

## Counterexample 1: High OCR quality but wrong window label
- Risk: text content can look correct while context label is stale.
- Mitigation: decouple OCR quality from metadata quality via `label_quality_score`.

## Counterexample 2: query-side dedup hides wrong provenance
- Risk: cleaner UI but incorrect attribution persists.
- Mitigation: source-level traceability and strict-mode filters.

## Counterexample 3: aggressive filtering lowers recall
- Risk: excluding fallback labels may remove true positives.
- Mitigation: keep strict mode opt-in and expose quality thresholds.

---

## 9. Screenpipe Alignment Matrix

| Topic | Screenpipe strategy | MyRecall Phase 2.7 alignment | Full alignment now? |
|---|---|---|---|
| Metadata truth timing | Capture-time context + event signals | Add per-frame source/confidence; keep current capture loop | No (partial) |
| Dedup semantics | Write-time uniqueness and dedup first | Label normalization + uniqueness constraints | Yes (high) |
| Index freshness | Deferred/background FTS refresh | Async incremental indexing SLA | Yes (high) |
| Query noise control | Evidence-first ranking and metadata filters | `label_quality_score` + strict fallback filtering | Yes (medium-high) |
| End-to-end event-driven capture | Native in capture runtime | Deferred (future candidate) | No |

---

## 10. Assumptions and Defaults

1. Structural alignment first; no full event-driven capture rewrite in Phase 2.7.
2. Phase 2.7 is a hard gate before Phase 3 kickoff.
3. Primary KPI is retrieval accuracy; latency and resources are secondary constraints.
4. SQLite/SQLStore remains the storage/index base for this phase.
5. Screenpipe philosophy is used as design benchmark; implementation remains MyRecall-native.

---

## 11. Rollback and Exit Criteria

Rollback if any of these occur:
- API response compatibility break for current clients.
- Query p95 regresses >10% with no compensating quality gain.
- Resource growth exceeds hard bounds for 2 consecutive validation windows.
- Forward-only schema/new-write integrity checks fail.

Exit to Phase 3 only after all Section 6 gates pass and evidence is attached to phase-gates and roadmap records.
